<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOEDOR AO VIVO</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #000;
            color: #fff;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 3rem;
            font-weight: bold;
            color: #ff0000;
            text-shadow: 2px 2px 4px rgba(255, 0, 0, 0.5);
            margin-bottom: 10px;
            animation: glitch 2s infinite;
        }
        
        @keyframes glitch {
            0%, 100% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #ccc;
        }
        
        .login-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }
        
        .login-form {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        
        .btn {
            background: #ff0000;
            color: #fff;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }
        
        .btn:hover {
            background: #cc0000;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 0, 0, 0.3);
        }
        
        .live-section {
            display: none;
        }
        
        .youtube-embed {
            width: 100%;
            height: 500px;
            margin-bottom: 30px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .youtube-embed iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .cameras-section {
            margin-bottom: 30px;
        }
        
        .cameras-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .cameras-title {
            font-size: 1.8rem;
            color: #ff0000;
            text-shadow: 1px 1px 2px rgba(255, 0, 0, 0.5);
        }
        
        .cameras-controls {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            background: #333;
            border: 1px solid #555;
        }
        
        .btn-small:hover {
            background: #555;
        }
        
        .cameras-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .camera-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .camera-item:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(255, 0, 0, 0.3);
        }
        
        .camera-stream {
            width: 100%;
            height: 240px;
            background: #222;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .camera-stream img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .camera-placeholder {
            color: #666;
            font-size: 18px;
        }
        
        .camera-info {
            padding: 15px;
            text-align: center;
        }
        
        .camera-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .camera-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-block;
        }
        
        .status-online {
            background: #00ff00;
            color: #000;
        }
        
        .status-offline {
            background: #ff0000;
            color: #fff;
        }
        
        .camera-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .camera-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .camera-modal.active {
            display: flex;
        }
        
        .camera-modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }
        
        .camera-modal img {
            width: 100%;
            height: auto;
            border-radius: 10px;
        }
        
        .camera-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: #ff0000;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .interaction-section {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        .messages-panel,
        .polls-panel,
        .actions-panel {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .polls-panel {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .poll-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #333;
        }
        
        .poll-question {
            font-weight: bold;
            margin-bottom: 10px;
            color: #fff;
        }
        
        .poll-option {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #555;
            border-radius: 5px;
            padding: 8px 12px;
            margin: 5px 0;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .poll-option:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #ff0000;
        }
        
        .poll-option.voted {
            background: rgba(255, 0, 0, 0.3);
            border-color: #ff0000;
        }
        
        .poll-votes {
            font-size: 12px;
            color: #ccc;
        }
        
        .poll-timer {
            text-align: center;
            font-size: 12px;
            color: #ff6600;
            margin-top: 10px;
        }
        
        .poll-results {
            margin-top: 10px;
        }
        
        .poll-result-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 20px;
            margin: 5px 0;
            overflow: hidden;
            position: relative;
        }
        
        .poll-result-fill {
            background: linear-gradient(90deg, #ff0000, #ff6600);
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .poll-result-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .no-polls {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .message-form {
            margin-bottom: 20px;
        }
        
        .message-form input,
        .message-form textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            transition: all 0.3s;
        }
        
        .message-form input:focus,
        .message-form textarea:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }
        
        .messages-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        .message-item {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .message-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .message-author {
            font-weight: bold;
            color: #ff0000;
        }
        
        .message-likes {
            float: right;
            color: #ff69b4;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .message-likes:hover {
            transform: scale(1.2);
        }
        
        .action-btn {
            width: 100%;
            margin-bottom: 15px;
            padding: 15px;
            font-size: 18px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .embarrassing-btn {
            background: linear-gradient(45deg, #ff6600, #ff3300);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .donation-btn {
            background: linear-gradient(45deg, #00ff00, #00cc00);
            color: #000;
        }
        
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 0, 0, 0.9);
            padding: 10px;
            text-align: center;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s;
        }
        
        .status-bar.show {
            transform: translateY(0);
        }
        
        .stats-bar {
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        
        .stat-item {
            flex: 1;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff0000;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #ccc;
        }
        
        @media (max-width: 768px) {
            .interaction-section {
                grid-template-columns: 1fr;
            }
            
            .cameras-grid {
                grid-template-columns: 1fr;
            }
            
            .logo {
                font-size: 2rem;
            }
            
            .cameras-header {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="status-bar" id="statusBar">
        <span id="statusText">Conectando...</span>
    </div>
    
    <div class="container">
        <div class="header">
            <div class="logo">MOEDOR AO VIVO</div>
            <div class="subtitle">A live mais interativa do YouTube</div>
        </div>
        
        <!-- Seção de Login -->
        <div class="login-section" id="loginSection">
            <h2>Seja Membro para Participar</h2>
            <p>Somente assinantes do Hotmart têm acesso a esta experiência exclusiva!</p>
            
            <div class="login-form">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" placeholder="Seu email cadastrado no Hotmart">
                </div>
                <button class="btn" onclick="login()">Entrar na Live</button>
            </div>
        </div>
        
        <!-- Seção da Live -->
        <div class="live-section" id="liveSection">
            <!-- Estatísticas -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-number" id="onlineUsers">0</div>
                    <div class="stat-label">Online</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalMessages">0</div>
                    <div class="stat-label">Mensagens</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalDonations">R$ 0</div>
                    <div class="stat-label">Doações</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="embarrassingCount">0/3</div>
                    <div class="stat-label">Vergonhas</div>
                </div>
            </div>
            
            <!-- YouTube Embed -->
            <div class="youtube-embed">
                <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" allowfullscreen></iframe>
            </div>
            
            <!-- Big Brother Moído -->
            <div class="cameras-section">
                <div class="cameras-header">
                    <h3 class="cameras-title">🎥 Big Brother Moído</h3>
                    <div class="cameras-controls">
                        <button class="btn btn-small" onclick="refreshCameras()">
                            <span id="refreshIcon">🔄</span> Atualizar
                        </button>
                        <button class="btn btn-small" onclick="toggleAllCameras()" id="toggleCamerasBtn">
                            ▶️ Iniciar Todas
                        </button>
                    </div>
                </div>
                <div class="cameras-grid" id="camerasGrid">
                    <!-- Câmeras serão carregadas aqui -->
                </div>
            </div>
            
            <!-- Modal para câmera ampliada -->
            <div class="camera-modal" id="cameraModal">
                <div class="camera-modal-content">
                    <button class="camera-modal-close" onclick="closeCameraModal()">✕</button>
                    <img id="modalCameraImage" src="" alt="Câmera ampliada">
                    <div id="modalCameraName" style="text-align: center; margin-top: 10px; font-size: 1.2rem;"></div>
                </div>
            </div>
            
            <!-- Interações -->
            <div class="interaction-section">
                <!-- Painel de Mensagens -->
                <div class="messages-panel">
                    <h3>💬 Mensagens</h3>
                    <div class="message-form">
                        <input type="text" id="fakeName" placeholder="Seu nome falso" maxlength="50">
                        <textarea id="messageContent" placeholder="Sua mensagem (máx 250 caracteres)" maxlength="250"></textarea>
                        <button class="btn" onclick="sendMessage()">Enviar Mensagem</button>
                    </div>
                    <div class="messages-list" id="messagesList">
                        <!-- Mensagens aparecerão aqui -->
                    </div>
                </div>
                
                <!-- Painel de Enquetes -->
                <div class="polls-panel">
                    <h3>📊 Enquetes Ativas</h3>
                    <div id="pollsContainer">
                        <div class="no-polls">Nenhuma enquete ativa no momento</div>
                    </div>
                </div>
                
                <!-- Painel de Ações -->
                <div class="actions-panel">
                    <h3>🎯 Ações</h3>
                    <button class="btn action-btn embarrassing-btn" onclick="embarrassingAction()">
                        ENVERGONHAR UM DOS INTEGRANTES
                        <br><small>R$ 20,00 - Os apresentadores ouvirão verdades constrangedoras</small>
                    </button>
                    <button class="btn action-btn donation-btn" onclick="donationAction()">
                        ENVIAR DINHEIRO - OLHA O AVIÃOZINHO
                        <br><small>Envie o valor que quiser por doação</small>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        let socket;
        let isAuthenticated = false;
        let cameras = [];
        let cameraUpdateInterval;
        
        // Verificar autenticação ao carregar
        window.onload = function() {
            checkAuthStatus();
        };
        
        function checkAuthStatus() {
            fetch('/api/auth/status')
                .then(response => response.json())
                .then(data => {
                    if (data.authenticated) {
                        isAuthenticated = true;
                        showLiveSection();
                        connectSocket();
                        loadCameras();
                        startStatsUpdate();
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar autenticação:', error);
                });
        }
        
        function login() {
            const email = document.getElementById('email').value;
            
            if (!email) {
                showStatus('Por favor, digite seu email', 'error');
                return;
            }
            
            fetch('/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    isAuthenticated = true;
                    showLiveSection();
                    connectSocket();
                    loadCameras();
                    loadPolls();
                    startStatsUpdate();
                    showStatus('Login realizado com sucesso!', 'success');
                } else {
                    showStatus('Erro no login: ' + (data.error || 'Usuário não encontrado'), 'error');
                }
            })
            .catch(error => {
                console.error('Erro no login:', error);
                showStatus('Erro de conexão', 'error');
            });
        }
        
        function showLiveSection() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('liveSection').style.display = 'block';
        }
        
        function connectSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Conectado ao servidor');
                showStatus('Conectado à live!', 'success');
            });
            
            socket.on('disconnect', function() {
                console.log('Desconectado do servidor');
                showStatus('Desconectado', 'error');
            });
            
            socket.on('new_message', function(data) {
                addMessageToList(data);
                updateStats();
            });
            
            socket.on('message_liked', function(data) {
                updateMessageLikes(data.message_id, data.likes_count);
            });
            
            socket.on('stats_update', function(data) {
                updateStatsDisplay(data);
            });
            
            socket.on('new_subscriber', function(data) {
                showStatus(`Novo membro: ${data.name}! 🍆`, 'success');
            });
            
            socket.on('donation_approved', function(data) {
                showStatus(`Doação de R$ ${data.amount} recebida! 💰`, 'success');
            });
            
            socket.on('embarrassing_queued', function(data) {
                showStatus(`Vergonha alheia na fila! Restam ${data.remaining}`, 'success');
            });
            
            socket.on('new_poll', function(data) {
                addPollToList(data);
                showStatus(`Nova enquete: ${data.question}`, 'success');
            });
            
            socket.on('poll_vote_update', function(data) {
                updatePollVotes(data.poll_id, data.option_id, data.votes, data.total_votes);
            });
            
            socket.on('poll_closed', function(data) {
                showPollResults(data.poll_id, data.results, data.total_votes);
                showStatus(`Enquete encerrada: ${data.question}`, 'success');
            });
            
            socket.on('poll_generated', function(data) {
                showStatus('Nova enquete gerada automaticamente!', 'success');
                loadPolls();
            });
        }
        
        function loadCameras() {
            fetch('/api/cameras/')
                .then(response => response.json())
                .then(data => {
                    cameras = data.cameras || [];
                    renderCameras();
                })
                .catch(error => {
                    console.error('Erro ao carregar câmeras:', error);
                });
        }
        
        function renderCameras() {
            const grid = document.getElementById('camerasGrid');
            
            if (cameras.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #666; grid-column: 1/-1;">Nenhuma câmera disponível</div>';
                return;
            }
            
            grid.innerHTML = '';
            
            cameras.forEach(camera => {
                const cameraDiv = document.createElement('div');
                cameraDiv.className = 'camera-item';
                cameraDiv.onclick = () => openCameraModal(camera);
                
                cameraDiv.innerHTML = `
                    <div class="camera-stream">
                        <div class="camera-overlay">${camera.is_streaming ? 'AO VIVO' : 'OFFLINE'}</div>
                        ${camera.is_streaming ? 
                            `<img src="/api/cameras/${camera.id}/stream" alt="${camera.name}" onerror="this.style.display='none'">` :
                            `<div class="camera-placeholder">📹 ${camera.name}</div>`
                        }
                    </div>
                    <div class="camera-info">
                        <div class="camera-name">${camera.name}</div>
                        <span class="camera-status ${camera.is_streaming ? 'status-online' : 'status-offline'}">
                            ${camera.is_streaming ? 'ONLINE' : 'OFFLINE'}
                        </span>
                    </div>
                `;
                
                grid.appendChild(cameraDiv);
            });
        }
        
        function refreshCameras() {
            const icon = document.getElementById('refreshIcon');
            icon.innerHTML = '<div class="loading"></div>';
            
            loadCameras();
            
            setTimeout(() => {
                icon.innerHTML = '🔄';
            }, 1000);
        }
        
        function toggleAllCameras() {
            const btn = document.getElementById('toggleCamerasBtn');
            const hasStreaming = cameras.some(c => c.is_streaming);
            
            const endpoint = hasStreaming ? '/api/cameras/stop-all' : '/api/cameras/start-all';
            
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div> Processando...';
            
            fetch(endpoint, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    showStatus(data.message || 'Operação realizada', 'success');
                    setTimeout(loadCameras, 2000);
                })
                .catch(error => {
                    console.error('Erro ao controlar câmeras:', error);
                    showStatus('Erro ao controlar câmeras', 'error');
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = hasStreaming ? '⏹️ Parar Todas' : '▶️ Iniciar Todas';
                });
        }
        
        function openCameraModal(camera) {
            if (!camera.is_streaming) return;
            
            const modal = document.getElementById('cameraModal');
            const image = document.getElementById('modalCameraImage');
            const name = document.getElementById('modalCameraName');
            
            image.src = `/api/cameras/${camera.id}/stream`;
            name.textContent = camera.name;
            
            modal.classList.add('active');
        }
        
        function closeCameraModal() {
            const modal = document.getElementById('cameraModal');
            modal.classList.remove('active');
        }
        
        function sendMessage() {
            if (!socket || !isAuthenticated) {
                showStatus('Você precisa estar conectado para enviar mensagens', 'error');
                return;
            }
            
            const fakeName = document.getElementById('fakeName').value.trim();
            const content = document.getElementById('messageContent').value.trim();
            
            if (!fakeName || !content) {
                showStatus('Por favor, preencha o nome e a mensagem', 'error');
                return;
            }
            
            socket.emit('send_message', {
                fake_name: fakeName,
                content: content
            });
            
            // Limpar formulário
            document.getElementById('messageContent').value = '';
        }
        
        function addMessageToList(message) {
            const messagesList = document.getElementById('messagesList');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-item';
            messageDiv.innerHTML = `
                <div class="message-author">${message.fake_name}</div>
                <div>${message.content}</div>
                <div class="message-likes" onclick="likeMessage(${message.id})">
                    ❤️ <span id="likes-${message.id}">${message.likes || 0}</span>
                </div>
            `;
            
            messagesList.insertBefore(messageDiv, messagesList.firstChild);
            
            // Manter apenas as últimas 20 mensagens
            while (messagesList.children.length > 20) {
                messagesList.removeChild(messagesList.lastChild);
            }
        }
        
        function likeMessage(messageId) {
            if (!socket || !isAuthenticated) return;
            
            socket.emit('like_message', { message_id: messageId });
        }
        
        function updateMessageLikes(messageId, likesCount) {
            const likesElement = document.getElementById(`likes-${messageId}`);
            if (likesElement) {
                likesElement.textContent = likesCount;
            }
        }
        
        function embarrassingAction() {
            if (confirm('Tem certeza que quer envergonhar um dos integrantes? Custa R$ 20,00')) {
                fetch('/api/donations/embarrassing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.open(data.payment_url, '_blank');
                        showStatus('Redirecionando para pagamento...', 'success');
                    } else {
                        showStatus('Erro: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    showStatus('Erro ao processar pagamento', 'error');
                });
            }
        }
        
        function donationAction() {
            const amount = prompt('Quanto você quer doar? (R$)');
            if (amount && !isNaN(amount) && parseFloat(amount) > 0) {
                fetch('/api/donations/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        amount: parseFloat(amount),
                        description: 'Doação para MOEDOR AO VIVO'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        window.open(data.payment_url, '_blank');
                        showStatus('Redirecionando para pagamento...', 'success');
                    } else {
                        showStatus('Erro: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    showStatus('Erro ao processar doação', 'error');
                });
            }
        }
        
        function startStatsUpdate() {
            updateStats();
            setInterval(updateStats, 30000); // Atualizar a cada 30 segundos
        }
        
        function updateStats() {
            Promise.all([
                fetch('/api/messages/stats').then(r => r.json()),
                fetch('/api/donations/stats').then(r => r.json())
            ])
            .then(([messageStats, donationStats]) => {
                document.getElementById('totalMessages').textContent = messageStats.total_messages || 0;
                document.getElementById('totalDonations').textContent = `R$ ${(donationStats.total_amount || 0).toFixed(2)}`;
                document.getElementById('embarrassingCount').textContent = `${donationStats.current_session?.embarrassing_count || 0}/3`;
            })
            .catch(error => {
                console.error('Erro ao atualizar estatísticas:', error);
            });
        }
        
        function updateStatsDisplay(data) {
            if (data.online_users !== undefined) {
                document.getElementById('onlineUsers').textContent = data.online_users;
            }
        }
        
        function showStatus(message, type) {
            const statusBar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = message;
            statusBar.style.background = type === 'success' ? 'rgba(0, 255, 0, 0.9)' : 'rgba(255, 0, 0, 0.9)';
            statusBar.classList.add('show');
            
            setTimeout(() => {
                statusBar.classList.remove('show');
            }, 3000);
        }
        
        // Fechar modal ao clicar fora
        document.getElementById('cameraModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCameraModal();
            }
        });
        
        // Tecla ESC para fechar modal
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCameraModal();
            }
        });
    </script>
</body>
</html>


        
        function loadPolls() {
            fetch('/api/polls/')
                .then(response => response.json())
                .then(data => {
                    renderPolls(data.polls || []);
                })
                .catch(error => {
                    console.error('Erro ao carregar enquetes:', error);
                });
        }
        
        function renderPolls(polls) {
            const container = document.getElementById('pollsContainer');
            
            if (polls.length === 0) {
                container.innerHTML = '<div class="no-polls">Nenhuma enquete ativa no momento</div>';
                return;
            }
            
            container.innerHTML = '';
            
            polls.forEach(poll => {
                const pollDiv = document.createElement('div');
                pollDiv.className = 'poll-item';
                pollDiv.id = `poll-${poll.id}`;
                
                const timeRemaining = Math.max(0, poll.time_remaining);
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                
                pollDiv.innerHTML = `
                    <div class="poll-question">${poll.question}</div>
                    <div class="poll-options" id="poll-options-${poll.id}">
                        ${poll.options.map(option => `
                            <div class="poll-option" onclick="voteOnPoll(${poll.id}, ${option.id})">
                                <span>${option.text}</span>
                                <span class="poll-votes" id="votes-${option.id}">0 votos</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="poll-timer" id="timer-${poll.id}">
                        ⏰ ${minutes}:${seconds.toString().padStart(2, '0')} restantes
                    </div>
                `;
                
                container.appendChild(pollDiv);
                
                // Iniciar countdown
                startPollCountdown(poll.id, timeRemaining);
            });
        }
        
        function startPollCountdown(pollId, initialTime) {
            let timeRemaining = initialTime;
            
            const interval = setInterval(() => {
                timeRemaining--;
                
                if (timeRemaining <= 0) {
                    clearInterval(interval);
                    const timerElement = document.getElementById(`timer-${pollId}`);
                    if (timerElement) {
                        timerElement.textContent = '⏰ Enquete encerrada';
                    }
                    return;
                }
                
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                
                const timerElement = document.getElementById(`timer-${pollId}`);
                if (timerElement) {
                    timerElement.textContent = `⏰ ${minutes}:${seconds.toString().padStart(2, '0')} restantes`;
                }
            }, 1000);
        }
        
        function voteOnPoll(pollId, optionId) {
            if (!socket || !isAuthenticated) {
                showStatus('Você precisa estar conectado para votar', 'error');
                return;
            }
            
            fetch(`/api/polls/${pollId}/vote`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ option_id: optionId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Marcar opção como votada
                    const optionElement = document.querySelector(`#poll-options-${pollId} .poll-option[onclick*="${optionId}"]`);
                    if (optionElement) {
                        optionElement.classList.add('voted');
                        optionElement.onclick = null; // Desabilitar clique
                    }
                    
                    showStatus('Voto registrado!', 'success');
                } else {
                    showStatus('Erro: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Erro ao votar:', error);
                showStatus('Erro ao registrar voto', 'error');
            });
        }
        
        function addPollToList(pollData) {
            const container = document.getElementById('pollsContainer');
            
            // Remover mensagem "nenhuma enquete"
            const noPolls = container.querySelector('.no-polls');
            if (noPolls) {
                noPolls.remove();
            }
            
            const pollDiv = document.createElement('div');
            pollDiv.className = 'poll-item';
            pollDiv.id = `poll-${pollData.poll_id}`;
            
            pollDiv.innerHTML = `
                <div class="poll-question">${pollData.question}</div>
                <div class="poll-options" id="poll-options-${pollData.poll_id}">
                    ${pollData.options.map(option => `
                        <div class="poll-option" onclick="voteOnPoll(${pollData.poll_id}, ${option.id})">
                            <span>${option.text}</span>
                            <span class="poll-votes" id="votes-${option.id}">0 votos</span>
                        </div>
                    `).join('')}
                </div>
                <div class="poll-timer" id="timer-${pollData.poll_id}">
                    ⏰ ${pollData.duration_minutes}:00 restantes
                </div>
            `;
            
            container.insertBefore(pollDiv, container.firstChild);
            
            // Iniciar countdown
            startPollCountdown(pollData.poll_id, pollData.duration_minutes * 60);
        }
        
        function updatePollVotes(pollId, optionId, votes, totalVotes) {
            const votesElement = document.getElementById(`votes-${optionId}`);
            if (votesElement) {
                votesElement.textContent = `${votes} votos`;
            }
        }
        
        function showPollResults(pollId, results, totalVotes) {
            const pollElement = document.getElementById(`poll-${pollId}`);
            if (!pollElement) return;
            
            const optionsContainer = document.getElementById(`poll-options-${pollId}`);
            if (!optionsContainer) return;
            
            // Substituir opções por resultados
            optionsContainer.innerHTML = results.map(result => `
                <div class="poll-result-bar">
                    <div class="poll-result-fill" style="width: ${result.percentage}%"></div>
                    <div class="poll-result-text">
                        ${result.text}: ${result.votes} votos (${result.percentage}%)
                    </div>
                </div>
            `).join('');
            
            // Atualizar timer
            const timerElement = document.getElementById(`timer-${pollId}`);
            if (timerElement) {
                timerElement.textContent = `✅ Enquete encerrada - ${totalVotes} votos totais`;
            }
        }

